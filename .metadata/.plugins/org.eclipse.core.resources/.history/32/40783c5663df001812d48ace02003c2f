/*
 * drv_w5500.c
 *
 *  Created on: Nov 3, 2018
 *      Author: mose
 */

#include "drv_w5500.h"
#include "drv_spi.h"
#include "drv_gpio.h"
#include "drv_usart.h"

void init_w5500()
{
  // reset
   gpio_init(SX1278_RESET, SX1278_RESET_GPIO, GPIO_Speed_2MHz, GPIO_Mode_Out_PP);
   sx1278_reset();


  spi2ResetSet(LOW);
  delay_1us(10000);
  spi2ResetSet(HIGH);
  delay_1us(10000);
  u8 chw[2] = {0x12, 0x34};
  u8 chr[2] = {0};
  w5500_write_nbytes(SIPR, COMMON_R | RWB_WRITE | VDM, chw, 2);
  w5500_read_nbytes(SIPR, COMMON_R | RWB_READ | VDM, chr, 2);
  if((chw[1] != chr[1]) || (chw[0] != chr[0]))
  {
    usart_send_string("w5500 Fault...\r\n");
  }
  else
  {
    usart_send_string("w5500 OK, Ver: 0x");
    u8 ver = 0;
    w5500_read_nbytes(VERSION, COMMON_R | RWB_READ | VDM, &ver, 1);
    usart_send_u8(ver);
    usart_send_string("\r\n");
    w5500_load_parament(&globalV.flashEnvValue);
  }
}
