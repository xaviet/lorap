/*
 * global.h
 *
 *  Created on: Nov 1, 2018
 *      Author: mose
 */

#ifndef GLOBAL_H_
#define GLOBAL_H_

#include "config.h"

struct SflashEnvValue
{
  __IO u8 envFlag; // 0: default; 1: valid
  __IO u8 upgradeFlag; // 0: default; 1: valid upgrade
  u32 upgradeDataSize;
  u32 appAddrBase;
  u8 ver;
  u8 id[4];
  u8 ip[4];
  u8 mask[4];
  u8 mac[6];
  u8 gwIp[4];
  u8 s1Dip[4];
  u8 s1Dport[2];
  u8 s1Sport[2];
  u8 pad[108];
  __IO u8 crc8;
};

struct ScommonBuffer
{
  u8 data[COMMONBUFFERLENGTH];
  u8 length;
};

struct SextiStates
{
  vu8 sx1278Busy;
  vu8 sx1278DioMapping1;
  vu8 sx1278RxDone;
  vu8 sx1278TxDone;
  vu8 w5500Int;
};

struct SstatesMachine
{
  vu32 msgId;
  vu32 startTicket;
};

struct SupgradeMsg
{
  struct SmsgHead msgHead;
  vu8 ver;
  u8 pos[4];
  u8 reserve1[4];
  vu8 flag;
  u8 dataSize[4];
  u8 reserve2[4];
  u8 reserve3[1];
  u8 data[COMMONBUFFERLENGTH];
};

struct SupgradeBuffer
{
  vu8 upgradeDataZone[FLASH_SECTOR_SIZE];
  vu32 upgradeDataGotSize;
  vu32 upgradeDataTotleSize;
  vu8 upgradeRepeat;
};

struct SglobalValue
{
  vu32 msTicket;
  vu32 upSeconds;
  vu8 ledStat;
  vu32 ledBlinkDiv;
  vu32 rebootPressedTime;
  struct SupgradeBuffer upgradeBuffer;
  struct SflashEnvValue flashEnvValue;
  struct SextiStates extiStates;
  struct ScommonBuffer usart1RxBuffer;
  struct ScommonBuffer usart2RxBuffer;
  struct ScommonBuffer loraRxBuffer;
  struct Sw5500SocketRxBuffer w5500RxBuffer;
  struct StaskComponents taskComps[EtaskMax];
  struct SconfigMsg loraLoginChannelConfig;
  struct SconfigMsg loraWorkChannelConfig;
  struct SworkDataMsg loraWorkChannelData;
  struct SstatesMachine heartBeatStatesMachine;
  struct SstatesMachine irqCallStatesMachine;
  struct SstatesMachine forwardStatesMachine;
  struct SstatesMachine upgradeStatesMachine;
  struct SupgradeMsg upgradeMsg;
};

extern struct SglobalValue globalV;

void init_global();

#endif /* GLOBAL_H_ */
