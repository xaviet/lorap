/*
 * drv_adxl345.c
 *
 *  Created on: Nov 21, 2018
 *      Author: mose
 */

#include "hw_config.h"
#include "drv_adxl345.h"
#include "drv_spi.h"
#include "drv_gpio.h"
#include "drv_usart.h"
#include "tools_lib.h"
#include "string.h"

void init_adxl345()
{
  u8 v = 0;
  usart_send_string("\tadxl345 Ver: 0x");
  adxl345_read(0x00, &v, 1);
  usart_send_u8(v);
  usart_send_string("\r\n");
}

void adxl345_write(vu8 addr, u8* buffer, vu8 size)
{
//  led_set(globalV.ledStat = !globalV.ledStat);
  vu8 i;
  gpio_set(ADXL345_GPIO, ADXL345_NSS, LOW);
  if(size == 1)
  {
    addr = addr & 0x3F;
  }
  else
  {
    addr = addr & 0x7F;
  }
  spiInOut(ADXL345_SPI, addr);
  for(i = 0; i < size; i++)
  {
    spiInOut(ADXL345_SPI, buffer[i]);
  }
  gpio_set(ADXL345_GPIO, ADXL345_NSS, HIGH);
}

void adxl345_read(vu8 addr, u8* buffer, vu8 size)
{
//  led_set(globalV.ledStat = !globalV.ledStat);
  vu8 i;
  gpio_set(ADXL345_GPIO, ADXL345_NSS, LOW);
  if(size == 1)
  {
    addr = addr & 0xBF;
  }
  else
  {
    addr = addr & 0xFF;
  }
  spiInOut(ADXL345_SPI, addr & 0x7F);
  for(i = 0; i < size; i++)
  {
    buffer[i] = spiInOut(ADXL345_SPI, 0);
  }
  gpio_set(ADXL345_GPIO, ADXL345_NSS, HIGH);
}
