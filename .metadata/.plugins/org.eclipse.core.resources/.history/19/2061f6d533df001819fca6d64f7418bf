/*
 * drv_spi.c
 *
 *  Created on: Nov 3, 2018
 *      Author: mose
 */

#include "drv_spi.h"

void init_spi()
{
  spi_init();
}

void spi_init(GPIO_TypeDef* gpio, u16 miso, u16 mosi, u16 clk, u16 nss, u16 speed)
{
  //SPI_1串口参数部分定义，SPI_1参数为时钟平时为高，上升沿采样
  gpio_init(LED_PIN, LED_GPIO, GPIO_Speed_2MHz, GPIO_Mode_Out_PP);

  GPIO_InitTypeDef  GPIO_InitStructure;

  //配置SPI1的MISO（PA6）为浮空输入
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
  GPIO_Init(GPIOA, &GPIO_InitStructure);
  //配置SPI1的MOSI（PA7）和SPI1的CLK（PA5）为复用推免输出
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
  GPIO_Init(GPIOA, &GPIO_InitStructure);
  //配置SPI1的NSS（PA4）和SPI1的Reset（PA1）为推免输出
  GPIO_InitStructure.GPIO_Pin = SPI1NSS | SPI1RESET;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  GPIO_Init(GPIOA, &GPIO_InitStructure);
 //SPI1同步参数初始化定义
  SPI_InitTypeDef SPI_InitStructure;
  SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;
  SPI_InitStructure.SPI_Mode = SPI_Mode_Master;
  SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;
  SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low;
  SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge;
  SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;
  //SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_16; // 5 MHz
  SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_8; // 10 MHz
  SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;
  SPI_InitStructure.SPI_CRCPolynomial = 7;
  SPI_Init(SPI1,&SPI_InitStructure);
  SPI_Cmd(SPI1,ENABLE);
}
