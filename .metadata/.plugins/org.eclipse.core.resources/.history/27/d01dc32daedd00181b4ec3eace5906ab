/*
 * drv_flash.c
 *
 *  Created on: Nov 1, 2018
 *      Author: mose
 */

#include "drv_flash.h"
#include "string.h"

void flash_init()
{

}

u8 flash_erase(u32 sector, u32 count)
{
  __disable_irq();
  FLASH_Unlock();
  u8 rt = TRUE;
  for(u32 i = 0; i < count; ++i)
  {
    if(FLASH_ErasePage((u32)FLASH_SECTOR_ADDR(sector) + i * FLASH_SECTOR_SIZE) != FLASH_COMPLETE)
    {
      rt = FALSE;
      break;
    }
  }
  FLASH_Lock();
  __enable_irq();
  return(rt);
}

u32 flash_write(u32 sector, u8* buffer, u32 length)
{
  __disable_irq();
  FLASH_Unlock();
  u8 rt = TRUE;
  u16 data = 0;
  for(u32 i = 0; i < length; i += 2)
  {
    data = (*(buffer + i + 1) << 8) + (*(buffer + i));
    if(FLASH_ProgramHalfWord((u32)(FLASH_SECTOR_ADDR(sector) + i), data) != FLASH_COMPLETE)
    {
      rt = FALSE;
      break;
    }
  }
  rt = length;
  FLASH_Lock();
  __enable_irq();
  return(rt);
}

u32 flash_read(u32 sector, u8* buffer, u32 length)
{
  memcpy(buffer, (void*)FLASH_SECTOR_ADDR(sector), length);
  return(length);
}

